<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat + Player Completo</title>
  <style>
    /* Estilos Globais e Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    /* Telas de Setup e Espera (Menu Inicial, Nome, Aprova√ß√£o, Recusado) */
    #menuSetup, #namePrompt, #waitingApproval, #rejectedNotice {
      padding:1rem; /* */
      display:flex; /* */
      flex-direction:column; /* */
      gap:.5rem; /* */
      align-items:center; /* */
      text-align:center; /* */
      justify-content: center; /* Centraliza verticalmente */
      flex: 1; /* */
    /* Permite que ocupe o espa√ßo dispon√≠vel */
    }

    /* Layout Principal da UI (PC Padr√£o) */
    #mainUI{
      display:none; /* Inicia oculto, ser√° 'flex' ap√≥s login */
      flex:1; /* Ocupa o espa√ßo dispon√≠vel */
      flex-direction:row; /* Player e Chat lado a lado no PC */
      max-width:1200px; /* Largura m√°xima para PCs */
      margin:0 auto; /* Centraliza */
      position:relative;
      padding: 1rem; /* Espa√ßamento interno */
    }

    /* Estilos do Player */
    #playerArea{
      flex:2; /* Ocupa 2/3 do espa√ßo dispon√≠vel */
      background:#222;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:1rem;
      position:relative;
      border-radius: 8px; /* Bordas arredondadas */
    }
    #mediaPlayerContainer { /* Novo cont√™iner para o player */
        width: 100%;
        max-width: 800px;
        position: relative;
        padding-top: 56.25%; /* Propor√ß√£o 16:9 (altura/largura = 0.5625) */
        background: #000;
        border-radius: 6px;
        overflow: hidden;
    }
    #mediaPlayer, #externalPlayer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        background:#000; /* Garante fundo preto para v√≠deo */
        z-index: 1; /* */
    }
    #controls{
      margin:1rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap; /* Quebra bot√µes em m√∫ltiplas linhas se necess√°rio */
      position:relative;
      z-index:1;
      justify-content: center; /* Centraliza os bot√µes */
    }
    .btn{
      background:#ff4500;
      border:none; /* */
      color:#FFF;
      padding:.5rem 1rem;
      border-radius:5px;
      cursor:pointer;
      z-index:1;
      font-size: 0.9rem; /* Ajuste para bot√µes */
    }
    .btn:hover {
        opacity: 0.9; /* */
    }

    /* Estilos do Chat */
    #chatArea{
      flex:1; /* Ocupa 1/3 do espa√ßo dispon√≠vel */
      display:flex;
      flex-direction:column;
      background:#1f1f1f;
      border-left:1px solid #333;
      position:relative; /* */
      border-radius: 8px;
      margin-left: 0.5rem; /* Espa√ßamento entre player e chat no PC */
    }
    #chatLog{
      flex:1; /* */
      overflow-y:auto;
      padding:.5rem;
      word-wrap: break-word; /* Quebra palavras longas */
    }
    #chatInputArea{
        padding:.5rem; /* */
        display:flex; /* Usa flexbox para alinhar input e bot√µes */
        gap:.5rem; /* */
        border-top: 1px solid #333; /* Separador para a √°rea de input */
        align-items: flex-end; /* Alinha os itens pela parte de baixo */
    }
    #chatInput{
        flex:1; /* */
        padding:.5rem; /* */
        border-radius:4px;
        border:none;
        background:#222;
        color:#EEE;
        resize: vertical; /* Permite redimensionar verticalmente */
        max-height: 150px; /* Limite de altura para n√£o "estourar" o layout */
        min-height: 40px; /* Altura m√≠nima para o textarea */
        min-width: 100px; /* Largura m√≠nima para o textarea */
        overflow: auto; /* Garante que o conte√∫do tenha scroll se o textarea for menor que o conte√∫do */
    }
    #sendChatBtn, #shareRoomCodeBtn {
        height: 40px; /* Ajusta altura dos bot√µes para alinhar com o input */
        flex-shrink: 0; /* Impede que os bot√µes diminuam */
        padding: 0.5rem 0.8rem; /* Ajusta padding */
    }
    #shareRoomCodeBtn {
        background-color: #007bff; /* Cor diferente para o bot√£o de compartilhar */
        display: flex;
        align-items: center; /* */
        justify-content: center; /* */
    }
    #shareRoomCodeBtn svg {
        width: 18px;
        height: 18px; /* */
        fill: white;
    }

    /* Estilos dos Modais (Padr√£o para Telas Maiores) */
    #fileMenuModal, #participantListModal, #playlistModal{
      position:fixed; /* */
      top:0; /* */
      left:0; /* */
      right:0; /* */
      bottom:0; /* */
      background:rgba(0,0,0,0.75);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #fileMenuContent, #participantListContent, #playlistContent{
      background:#333; /* */
      padding:1.5rem; /* */
      border-radius:8px;
      min-width:320px;
      display:flex;
      flex-direction:column;
      gap:.75rem;
      position:relative;
      max-height:90vh;
      overflow-y:auto;
    }
    .closeBtn{
      position:absolute; /* */
      top:10px; /* */
      right:10px; /* */
      background:#a00;
      color:#fff;
      border:none;
      border-radius:50%;
      width:24px;
      height:24px;
      font-weight:bold;
      cursor:pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem; /* */
    }

    /* Estilos de Itens da Playlist/Participantes */
    .playlistItem{display:flex;justify-content:space-between;align-items:center;padding:.5rem;margin-bottom:.3rem;background:#2a2a2a; /* */
    border-radius: 4px;}
    .playlistItem span{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .playlistItem small{opacity:0.7; /* */
    margin-left: 0.5rem;}
    #rejectedNotice img {width: 64px;height: 64px;margin-bottom: 0.5rem;}

    /* Classe para mensagens privadas (comandos) */
    .private-message {
        color: #ff9933; /* Vermelho-alaranjado */
        font-style: italic; /* */
    }
    .system-message {
        color: #aaa;
        font-style: italic; /* */
    }
    .warning-message {
        color: yellow;
        font-style: italic; /* */
    }

    /* --- MEDIA QUERIES --- */

    /* Para Telas de Telefone/Tablet (Largura m√°xima de 768px) */
    @media (max-width: 768px) {
      body {
        justify-content: flex-start; /* Alinha o conte√∫do ao topo para n√£o haver espa√ßo vazio */
      }

      /* Menu Inicial, Nome de Usu√°rio, Espera e Recusa */
      #menuSetup, #namePrompt, #waitingApproval, #rejectedNotice {
        width: 90%; /* Ocupa a maior parte da largura */
        max-width: 400px; /* Mas n√£o fica muito grande */
        margin: auto; /* Centraliza horizontalmente */
        padding: 1.5rem; /* Mais espa√ßamento */
        border-radius: 8px;
        background: #1f1f1f; /* Fundo para se destacar */
      }
      #menuSetup input, #namePrompt input {
        width: 100%; /* */
        padding: 0.8rem;
        font-size: 1rem;
      }
      #menuSetup .btn, #namePrompt .btn, #rejectedNotice .btn {
        width: 100%; /* */
        padding: 0.8rem;
        font-size: 1rem;
      }

      /* Layout Principal dentro da Sala (Mobile) */
      #mainUI{
        flex-direction:column; /* Player em cima, chat embaixo */
        width:100%; /* Ocupa 100% da largura */
        height:100vh; /* Ocupa a altura total da viewport */
        padding:.5rem; /* Menor padding */
      }
      #playerArea{
        width:100%; /* Player ocupa 100% da largura */
        height: auto; /* Altura autom√°tica */
        padding: 0.5rem;
        border-radius: 0; /* Remove bordas arredondadas em mobile para melhor preenchimento */
      }
      #mediaPlayerContainer {
        max-width: none; /* Remove limite de largura para preencher a tela */
        border-radius: 0; /* */
      }
      #controls {
        margin-top: 0.5rem; /* Ajusta margem para os bot√µes */
      }
      #chatArea{
        width:100%; /* Chat ocupa 100% da largura */
        height:150px; /* Altura fixa para o chat em mobile */
        border-left:none; /* Remove borda esquerda */
        border-top:1px solid #333; /* Adiciona borda superior */
        margin-top:.5rem; /* Espa√ßamento entre player e chat */
        margin-left: 0; /* Remove margem esquerda */
        border-radius: 0; /* Remove bordas arredondadas */
      }
      #chatInputArea {
        /* No mobile, os bot√µes ficam ao lado do textarea */
        flex-direction: row; /* Mant√©m em linha */
        align-items: flex-end; /* Alinha na parte de baixo */
      }
      #chatInput {
          max-height: 100px; /* Limita a altura do input em mobile */
          min-height: 35px; /* */
          resize: vertical; /* Permite redimensionar verticalmente apenas em mobile */
      }
      #shareRoomCodeBtn {
          /* No mobile, o bot√£o de compartilhar deve ficar vis√≠vel */
          display: flex; /* */
          order: -1; /* Coloca o bot√£o de compartilhar antes do input */
      }
      #sendChatBtn {
          order: 1; /* Coloca o bot√£o de enviar depois do input */
      }
    }

    /* Para Telas de TV (Largura m√≠nima de 1600px, adaptando seu breakpoint) */
    @media (min-width: 1600px) {
      #mainUI{
        max-width:1800px; /* Aumenta a largura m√°xima para TVs */
        margin:2rem auto;
        border:1px solid #444; /* */
        border-radius:10px;
        box-shadow:0 0 20px #0008;
        padding: 1.5rem; /* Mais padding interno */
      }

      #playerArea {
        padding: 1.5rem; /* Mais padding interno */
        flex: 3; /* Player ocupa mais espa√ßo */
      }
      #mediaPlayerContainer {
        max-width: 1000px; /* Aumenta o max-width do v√≠deo */
      }

      #chatArea{
        flex: 1; /* Chat ocupa menos espa√ßo proporcionalmente */
        max-width: 350px; /* Largura fixa para o chat em TVs */
        margin-left: 1.5rem; /* Mais espa√ßamento */
        height: auto; /* Altura autom√°tica */
      }

      /* Modais para TV (Posicionados sem cobrir tudo) */
      #fileMenuModal, #participantListModal, #playlistModal {
        background:rgba(0,0,0,0.5); /* Fundo um pouco mais transparente */
      }
      #fileMenuContent, #participantListContent, #playlistContent {
        min-width: 400px; /* Aumenta o tamanho m√≠nimo dos modais */
        max-width: 600px;
        position: absolute; /* Permite posicionamento absoluto */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Centraliza modais */
      }
      /* Ajuste espec√≠fico para posicionar modais pr√≥ximos ao chat */
      #participantListModal #participantListContent,
      #playlistModal #playlistContent {
          top: 2rem; /* Mais perto do topo */
          right: 2rem; /* Alinhado √† direita */
          left: unset; /* Desativa centraliza√ß√£o horizontal */
          transform: unset; /* Remove transform */
          margin-left: auto; /* Empurra para a direita */
          margin-right: 0; /* */
      }
      #fileMenuModal #fileMenuContent {
          top: 2rem; /* */
          left: 2rem; /* */
          right: unset;
          transform: unset;
          margin-left: 0;
          margin-right: auto; /* */
      }
    }

    /* Estilos para o rejectedNotice (mant√©m o flex-direction) */
    #rejectedNotice {
      flex-direction: column; /* */
      gap: 0.5rem;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="menuSetup">
    <label for="roomCode" class="sr-only">C√≥digo da sala</label>
    <input id="roomCode" placeholder="C√≥digo da sala (ex: A91J)" maxlength="4" style="text-transform:uppercase" aria-label="Campo para inserir o c√≥digo da sala" />
    <button id="createRoom" class="btn" aria-label="Criar uma nova sala e configurar o nome">Criar Sala</button>
    <button id="joinRoom" class="btn" aria-label="Entrar em uma sala existente com c√≥digo">Entrar na Sala</button>
  </div>

  <div id="namePrompt" style="display:none;">
    <label for="nickname" class="sr-only">Nome de usu√°rio</label>
    <input id="nickname" placeholder="Seu nome de usu√°rio" aria-label="Campo para inserir o seu nome"/>
    <button id="enterRoom" class="btn" aria-label="Confirmar e entrar na sala">Entrar</button> </div>

  <div id="waitingApproval" style="display:none;">
    <img src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" alt="Carregando" width="64" height="64"/>
    <p aria-live="assertive">Esperando o Administrador aceitar sua solicita√ß√£o :D</p>
  </div>

  <div id="rejectedNotice" style="display:none;">
    <img src="https://img.freepik.com/free-icon/cancel_318-10762.jpg" alt="Recusado"/>
    <p>O Administrador (A) da sala recusou a sua solicita√ß√£o de entrada :(</p>
    <button id="retryEntryBtn" class="btn">Tentar novamente</button>
  </div>
  <div id="mainUI">
    <div id="playerArea">
      <div id="mediaPlayerContainer">
        <video id="mediaPlayer" controls autoplay></video>
        </div>
      <div id="controls">
        <button id="chooseMediaBtn" class="btn" aria-label="Abrir op√ß√µes para adicionar m√≠dia">Escolher Arquivo/Link/Tela</button> <button id="showPlaylistBtn" class="btn" aria-label="Ver lista de reprodu√ß√£o">üìÉ Playlist</button>
        <button id="showParticipantsBtn" class="btn" aria-label="Mostrar participantes da sala">üë• Participantes</button>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatLog" aria-live="polite"></div>
      <div id="chatInputArea">
        <label for="chatInput" class="sr-only">Mensagem</label>
        <textarea id="chatInput" placeholder="Digite sua mensagem (m√°x 900 caracteres)" autocomplete="off" aria-label="Campo de mensagem" maxlength="900" rows="2"></textarea>
        <button id="shareRoomCodeBtn" class="btn" aria-label="Compartilhar c√≥digo da sala">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.52.47 1.2.77 1.96.77 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L7.94 11.3c-.52-.47-1.2-.77-1.96-.77-1.66 0-3 1.34-3 3s1.34 3 3 3c.76 0 1.44-.3 1.96-.77l7.05 4.11c-.05.23-.09.46-.09.7 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg>
        </button>
        <button id="sendChatBtn" class="btn" aria-label="Enviar mensagem">Enviar</button>
      </div>
    </div>
  </div>

  <div id="fileMenuModal">
    <div id="fileMenuContent"> <button class="closeBtn" onclick="document.getElementById('fileMenuModal').style.display='none'" aria-label="Fechar menu de m√≠dia">√ó</button>
      <button id="selectFileBtn" class="btn" aria-label="Escolher um arquivo de v√≠deo ou √°udio do seu dispositivo">Escolher do dispositivo</button>
      <button id="insertLinkBtn" class="btn" aria-label="Inserir um link direto para o v√≠deo">Inserir link de M√≠dia</button>
      <button id="shareScreenBtn" class="btn" aria-label="Transmitir a tela ao vivo">Transmitir Tela</button>
    </div>
  </div>

  <div id="participantListModal">
    <div id="participantListContent">
      <button class="closeBtn" onclick="document.getElementById('participantListModal').style.display='none'" aria-label="Fechar lista de participantes">√ó</button>
      <div id="participantList"></div>
    </div> </div>

  <div id="playlistModal">
    <div id="playlistContent">
      <button class="closeBtn" onclick="document.getElementById('playlistModal').style.display='none'" aria-label="Fechar lista de reprodu√ß√£o">√ó</button>
      <div id="playlistItems"></div>
    </div>
  </div>

  <audio id="memeSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>

  <script>
    let isCreatingRoom = false; /* */
    let myName = '';
    let roomID = ''; // Vari√°vel global para armazenar o c√≥digo da sala

    // Simula√ß√£o de sala e participantes
    let isAdmin = false; /* */
    // Flag para verificar se o usu√°rio atual √© o administrador
    let approvalTimeout = null; /* */
    let waitingForApproval = false;

    // Dados
    const playlist = [];
    const participants = []; /* */
    // A lista de salas v√°lidas ser√° populada dinamicamente para simular um servidor
    const validRooms = new Set(); /* */
    const bannedUsers = new Map(); // Map(nomeDoUsuario, { banUntil: timestamp, reason: 'motivo' })

    // Fun√ß√£o para adicionar mensagem de sistema no chat (para todos)
    function addSystemMessage(msg) {
      const chatLog = document.getElementById('chatLog'); /* */
      const p = document.createElement('p');
      p.classList.add('system-message');
      p.textContent = msg;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight; /* */
      // === CORRE√á√ÉO DO BUG: Processa mensagens de sistema para atualizar validRooms ===
      const roomCodeMatch = msg.match(/\[Sistema: C√≥digo da Sala \((\w{4})\)\]/); /* */
      if (roomCodeMatch && roomCodeMatch[1]) {
          const newRoomCode = roomCodeMatch[1];
          validRooms.add(newRoomCode); /* */
          console.log(`[DEBUG] Sala ${newRoomCode} adicionada a validRooms globalmente.`);
      }
    }

    // Fun√ß√£o para adicionar mensagem privada (apenas para o usu√°rio atual)
    function addPrivateMessage(msg, isWarning = false) {
      const chatLog = document.getElementById('chatLog'); /* */
      const p = document.createElement('p');
      p.classList.add('private-message');
      if (isWarning) {
        p.classList.add('warning-message'); /* */
      }
      p.textContent = `[Voc√™]: ${msg}`;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight; /* */
    }

    // Fun√ß√£o para adicionar mensagem de chat normal (simula broadcast para todos)
    function addChatMessage(sender, message) {
      const chatLog = document.getElementById('chatLog'); /* */
      const p = document.createElement('p');
      p.textContent = `${sender}: ${message}`;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight; /* */
    }

    // Fun√ß√£o para atualizar participantes
    function updateParticipantList() {
      const list = document.getElementById('participantList'); /* */
      list.innerHTML = '';
      if (participants.length === 0) {
        list.textContent = 'Nenhum participante na sala.'; /* */
        return;
      }
      participants.forEach(p => {
        const div = document.createElement('div');
        div.className = 'playlistItem';
        let role = '';
        if (p.isAdmin) role = '(admin)';
        else if (p.isMod) role = '(mod)';
        div.textContent = `${p.name} ${role}`;
        list.appendChild(div);
      }); /* */
    }

    // Fun√ß√£o atualizar playlist
    function updatePlaylist() {
      const list = document.getElementById('playlistItems'); /* */
      list.innerHTML = '';
      if (playlist.length === 0) {
        list.textContent = 'Playlist vazia.';
        return; /* */
      }
      playlist.forEach(item => {
        const div = document.createElement('div');
        div.className = 'playlistItem';
        const span = document.createElement('span');
        span.textContent = item.name;
        const small = document.createElement('small');
        small.textContent = `${item.type.toUpperCase()} - adicionado por ${item.addedBy}`;
        div.appendChild(span);
        div.appendChild(small);
        list.appendChild(div);
      }); /* */
    }

    // Mostrar modais
    document.getElementById('chooseMediaBtn').onclick = () => {
      document.getElementById('fileMenuModal').style.display = 'flex'; /* */
    };

    document.getElementById('showParticipantsBtn').onclick = () => {
      updateParticipantList();
      document.getElementById('participantListModal').style.display = 'flex';
    }; /* */
    document.getElementById('showPlaylistBtn').onclick = () => {
      updatePlaylist();
      document.getElementById('playlistModal').style.display = 'flex';
    }; /* */
    // Escolher arquivo do dispositivo
    document.getElementById('selectFileBtn').onclick = () => {
      const input = document.createElement('input'); /* */
      input.type = 'file';
      input.accept = 'video/*,audio/*';
      input.onchange = () => {
        const file = input.files[0]; /* */
        if (file) {
          const url = URL.createObjectURL(file);
          playAndBroadcast(url, 'arquivo', file.name); /* */
          document.getElementById('fileMenuModal').style.display = 'none';
        }
      };
      input.click();
    }; /* */

    // Inserir link
    document.getElementById('insertLinkBtn').onclick = () => {
      const url = prompt('Insira o link do v√≠deo, √°udio ou live (YouTube, Twitch, Vimeo, DailyMotion, SoundCloud):'); /* */
      if (!url) return;

      let mediaType = 'link';
      let mediaName = 'Link Externo';
      let processedUrl = url;
      let isValidEmbedOrDirectLink = false; // Flag para rastrear se o link √© v√°lido

      const youtubeMatch = url.match(/(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      const twitchMatch = url.match(/(?:twitch\.tv\/([a-zA-Z0-9_]+)(?:\/videos\/(\d+))?)/);
      const vimeoMatch = url.match(/(?:vimeo\.com\/(?:video\/)?([0-9]+))/);
      const dailymotionMatch = url.match(/(?:dailymotion\.com\/(?:video|hub)\/([a-zA-Z0-9]+))/);
      const soundcloudMatch = url.match(/(?:soundcloud\.com|snd\.sc)\/(.*)/);
      const directMediaMatch = /\.(mp4|webm|ogg|mp3|wav)(\?.*)?$/i.test(url);


      if (youtubeMatch) {
          processedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=1&controls=1`; // CORRIGIDO: URL correta para embed do YouTube
          mediaName = 'YouTube Video';
          mediaType = 'youtube';
          isValidEmbedOrDirectLink = true;
      } else if (twitchMatch) {
          const channel = twitchMatch[1];
          const videoId = twitchMatch[2];
          if (videoId) { // Twitch VOD
              processedUrl = `https://player.twitch.tv/?video=${videoId}&parent=${window.location.hostname}&autoplay=true`;
              mediaName = 'Twitch VOD';
              mediaType = 'twitch_vod';
          } else { // Twitch Live Stream
              processedUrl = `https://player.twitch.tv/?channel=${channel}&parent=${window.location.hostname}&autoplay=true`;
              mediaName = `Twitch Live: ${channel}`;
              mediaType = 'twitch_live';
          }
          isValidEmbedOrDirectLink = true;
      } else if (vimeoMatch) {
          processedUrl = `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`;
          mediaName = 'Vimeo Video';
          mediaType = 'vimeo';
          isValidEmbedOrDirectLink = true;
      } else if (dailymotionMatch) {
          processedUrl = `https://www.dailymotion.com/embed/video/${dailymotionMatch[1]}?autoplay=1`;
          mediaName = 'DailyMotion Video';
          mediaType = 'dailymotion';
          isValidEmbedOrDirectLink = true;
      } else if (soundcloudMatch) {
          mediaName = 'SoundCloud Audio';
          mediaType = 'soundcloud';
          // processedUrl permanece o URL original, pois playAndBroadcast ir√° construir o embed
          isValidEmbedOrDirectLink = true;
      } else if (directMediaMatch) { // Arquivo de v√≠deo/√°udio direto
          mediaName = url.split('/').pop().split('?')[0];
          mediaType = 'direct_media'; // Novo tipo para clareza
          isValidEmbedOrDirectLink = true;
      } else if (url.startsWith('https://') || url.startsWith('http://')) { // Permite outros links http/https, mas com aviso
          addPrivateMessage('Aviso: O link inserido n√£o √© um formato de m√≠dia reconhecido (v√≠deo/√°udio direto ou servi√ßo embed). Pode n√£o funcionar como esperado.', true);
          mediaName = url; // Usa o URL completo como nome
          mediaType = 'unknown_link';
          isValidEmbedOrDirectLink = true;
      }

      if (!isValidEmbedOrDirectLink) {
          alert('Link inv√°lido. Por favor, insira um link direto de m√≠dia ou de um servi√ßo suportado (YouTube, Twitch, Vimeo, DailyMotion, SoundCloud).');
          return;
      }

      playAndBroadcast(processedUrl, mediaType, mediaName);
      document.getElementById('fileMenuModal').style.display = 'none';
    };

    // Compartilhar tela
    document.getElementById('shareScreenBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }); /* */
        const mediaPlayerContainer = document.getElementById('mediaPlayerContainer');
        mediaPlayerContainer.innerHTML = ''; // Limpa o conte√∫do
        const video = document.createElement('video');
        video.id = 'mediaPlayer'; // Mant√©m o ID para CSS
        video.controls = true;
        video.autoplay = true;
        video.srcObject = stream;
        mediaPlayerContainer.appendChild(video);
        
        // Simular broadcast para todos (no real app, enviaria o stream para todos)
        broadcastMedia('tela', 'Compartilhamento de tela'); /* */
        document.getElementById('fileMenuModal').style.display = 'none';
      } catch (err) {
        alert('Erro ao compartilhar tela: ' + err); /* */
      }
    };

    // Reseta player antes de tocar nova m√≠dia
    function resetPlayer() {
      const mediaPlayerContainer = document.getElementById('mediaPlayerContainer');
      mediaPlayerContainer.innerHTML = ''; // Remove qualquer player existente (video ou iframe)
      const video = document.createElement('video'); // Recria o elemento video padr√£o
      video.id = 'mediaPlayer';
      video.controls = true;
      video.autoplay = true; // Mant√©m autoplay, que pode ser controlado pelo usu√°rio
      mediaPlayerContainer.appendChild(video);
    }

    // Fun√ß√£o que toca e adiciona na playlist, simulando broadcast
    function playAndBroadcast(url, type, name) {
        resetPlayer(); // Chamar resetPlayer antes de carregar nova m√≠dia

        const mediaPlayerContainer = document.getElementById('mediaPlayerContainer');
        const videoPlayer = document.getElementById('mediaPlayer'); // O player de v√≠deo nativo

        if (type === 'youtube' || type === 'twitch_live' || type === 'twitch_vod' || type === 'vimeo' || type === 'dailymotion') {
            const iframe = document.createElement('iframe');
            iframe.id = 'externalPlayer'; // Novo ID para o iframe
            iframe.src = url;
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen = true;
            iframe.setAttribute('frameborder', '0');
            
            mediaPlayerContainer.innerHTML = ''; // Limpa o player de v√≠deo nativo
            mediaPlayerContainer.appendChild(iframe);
        } else if (type === 'soundcloud') {
            const iframe = document.createElement('iframe');
            iframe.id = 'externalPlayer';
            iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
            iframe.height = '166'; // Altura t√≠pica do player SoundCloud
            iframe.scrolling = 'no';
            iframe.frameBorder = 'no';
            iframe.allow = 'autoplay';
            
            mediaPlayerContainer.innerHTML = '';
            mediaPlayerContainer.appendChild(iframe);
        }
        else {
            videoPlayer.src = url; /* */
            videoPlayer.play();
        }

        // Atualiza playlist
        playlist.push({name, type, addedBy: myName, url}); // Armazena a URL original para sincroniza√ß√£o
        updatePlaylist(); /* */
        
        // Simular broadcast para participantes (em app real, enviar via WebSocket)
        broadcastMedia(url, type, name); /* */
    }

    // Simula broadcast de m√≠dia (placeholder)
    function broadcastMedia(url, type, name) {
      console.log(`[Broadcast] ${myName} adicionou ${name} (${type}) com URL: ${url}`); /* */
      // Em um app real, esta fun√ß√£o enviaria a URL e o tipo da m√≠dia
      // para um servidor via WebSocket, que ent√£o retransmitiria para todos
      // os outros clientes na mesma sala. Cada cliente chamaria
      // playAndBroadcast(url, type, name) para sincronizar o player.
    }

    // Simula o recebimento de m√≠dia por outros usu√°rios (apenas para debug/exemplo)
    function receiveMediaBroadcast(url, type, name) {
        console.log(`[Recebido] Recebendo m√≠dia: ${name} (${type}) com URL: ${url}`);
        // Em um app real, esta fun√ß√£o seria chamada quando um cliente recebe
        // a informa√ß√£o de nova m√≠dia do servidor.
        playAndBroadcast(url, type, name); // Outros clientes reproduzem a mesma m√≠dia
    }


    // Fun√ß√£o para processar o link de convite na URL
    function processInviteLink() {
        const urlParams = new URLSearchParams(window.location.search); /* */
        const code = urlParams.get('CODE');
        if (code) {
            document.getElementById('roomCode').value = code; /* */
            // Tenta juntar automaticamente se j√° tiver nome, caso contr√°rio, espera input
            // document.getElementById('joinRoom').click(); /* */
            // Removido para for√ßar o clique em "Entrar na Sala"
        }
    }

    // Criar sala
    document.getElementById('createRoom').onclick = () => {
      isCreatingRoom = true; /* */
      roomID = Math.random().toString(36).substring(2, 6).toUpperCase();
      validRooms.add(roomID); // Adiciona o novo ID √† lista de salas v√°lidas
      isAdmin = true; /* */
      document.getElementById('menuSetup').style.display = 'none';
      document.getElementById('namePrompt').style.display = 'flex';
    };

    // Entrar sala
    document.getElementById('joinRoom').onclick = () => {
      isCreatingRoom = false; /* */
      isAdmin = false; // Quem entra n√£o √© admin por padr√£o
      const inputRoomCode = document.getElementById('roomCode').value.trim().toUpperCase(); /* */
      if (!inputRoomCode) {
        alert('Por favor, insira o c√≥digo da sala.');
        return; /* */
      }
      if (!validRooms.has(inputRoomCode)) {
        alert(`Sala "${inputRoomCode}" n√£o existe ou foi deletada.`); /* */
        document.getElementById('roomCode').value = ''; // Limpa o campo
        return; /* */
      }
      roomID = inputRoomCode; // Define o roomID para a sala que est√° sendo acessada
      document.getElementById('menuSetup').style.display = 'none'; /* */
      document.getElementById('namePrompt').style.display = 'flex';
    };

    // Confirmar entrada na sala
    document.getElementById('enterRoom').onclick = () => {
      myName = document.getElementById('nickname').value.trim(); /* */
      if (!myName) {
        alert('Por favor, insira seu nome de usu√°rio.');
        return; /* */
      }

      // Verifica se o usu√°rio est√° banido
      const banInfo = bannedUsers.get(myName); /* */
      if (banInfo && banInfo.banUntil > Date.now()) {
        const remainingTime = Math.ceil((banInfo.banUntil - Date.now()) / (1000 * 60)); /* */
        // Minutos
        alert(`Voc√™ est√° banido por ${remainingTime} minutos. Motivo: ${banInfo.reason || 'Nenhum.'}`);
        return; /* */
      }

      if (isCreatingRoom) { // Se est√° criando a sala (√© o administrador)
        participants.push({name: myName, isAdmin: true, isMod: false}); /* */
        alert(`Sala criada! C√≥digo: ${roomID}\nVoc√™ √© o administrador.`);
        document.getElementById('namePrompt').style.display = 'none';
        document.getElementById('mainUI').style.display = 'flex';
        updateParticipantList();
        updatePlaylist();
        addSystemMessage(`[Sistema: C√≥digo da Sala (${roomID})]`); /* */
        // Adiciona o c√≥digo da sala ao chat para "sincronizar"
        addPrivateMessage(`Bem-vindo, ${myName}! Voc√™ √© o administrador.`); /* */
      } else { // Se est√° tentando entrar em uma sala
        document.getElementById('namePrompt').style.display = 'none'; /* */
        document.getElementById('waitingApproval').style.display = 'flex';
        waitingForApproval = true;
        document.getElementById('memeSound').play(); // Toca o som para o solicitante

        // Simula√ß√£o da aprova√ß√£o do administrador
        // Em um app real, esta solicita√ß√£o seria enviada ao admin via WebSocket
        // e a aprova√ß√£o/recusa viria como resposta.
        
        // Simula a presen√ßa de um administrador para que a caixa de di√°logo de aprova√ß√£o apare√ßa
        const adminInRoom = participants.find(p => p.isAdmin);

        if (adminInRoom) {
            if (approvalTimeout) clearTimeout(approvalTimeout); /* */
            // Simula o tempo que levaria para o admin "responder"
            approvalTimeout = setTimeout(() => {
                document.getElementById('waitingApproval').style.display = 'none';
                waitingForApproval = false;
                const aprovado = confirm(`O administrador da sala (${adminInRoom.name}) precisa aceitar sua solicita√ß√£o.\nO participante ${myName} quer entrar na sala ${roomID}. Aceitar?`); /* */
                
                if (aprovado) {
                    participants.push({name: myName, isAdmin: false, isMod: false});
                    document.getElementById('mainUI').style.display = 'flex';
                    updateParticipantList(); /* */
                    updatePlaylist();
                    addSystemMessage(`${myName} entrou na sala.`);
                    addPrivateMessage(`Voc√™ foi aceito na sala ${roomID}!`);
                } else {
                    document.getElementById('rejectedNotice').style.display = 'flex'; /* */
                    addPrivateMessage(`Sua solicita√ß√£o para a sala ${roomID} foi recusada.`, true); // Mensagem de aviso
                }
            }, 3000); // Simula 3 segundos para o admin responder
        } else {
            // Se n√£o h√° admin na simula√ß√£o para aprovar
            document.getElementById('waitingApproval').style.display = 'none'; /* */
            waitingForApproval = false;
            document.getElementById('rejectedNotice').style.display = 'flex';
            addPrivateMessage(`Sua solicita√ß√£o para a sala ${roomID} foi recusada (sem administrador online para aprovar).`, true); /* */
        }
      }
    }; /* */
    // Bot√£o tentar novamente
    document.getElementById('retryEntryBtn').onclick = () => {
      document.getElementById('rejectedNotice').style.display = 'none'; /* */
      document.getElementById('menuSetup').style.display = 'flex'; // Volta para a tela inicial para inserir um novo c√≥digo ou criar sala
      document.getElementById('roomCode').value = ''; /* */
      // Limpa o c√≥digo da sala
      document.getElementById('nickname').value = ''; /* */
      // Limpa o nickname
      document.getElementById('roomCode').focus();
    }; /* */
    // === FUN√á√ÉO DE COMANDOS ===
    function handleCommand(message) {
        const parts = message.split(' '); /* */
        const command = parts[0].toLowerCase(); // Ex: /clear /* */
        const targetName = parts[1]; /* */
        // Ex: (Nome do usuario)
        const restOfMessage = parts.slice(2).join(' '); /* */
        // Mensagem ou tempo

        const currentUser = participants.find(p => p.name === myName); /* */
        const canAdmin = currentUser && currentUser.isAdmin;
        const canMod = currentUser && (currentUser.isAdmin || currentUser.isMod); /* */
        switch (command) {
            // --- Comandos de Admin ---
            case '/clear':
            case '/clearall':
                if (canAdmin || canMod) { // Mods tamb√©m podem limpar o chat
                    document.getElementById('chatLog').innerHTML = ''; /* */
                    // Limpa o chat
                    addSystemMessage('O hist√≥rico do chat foi limpo por um administrador/moderador.'); /* */
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            // Comando processado

            case '/kick':
                if (canAdmin || canMod) { // Mods tamb√©m podem kickar
                    if (!targetName) {
                        addPrivateMessage('Uso: /Kick (Nome do usuario) (Mensagem)', true); /* */
                        return true;
                    }
                    const kickedUserIndex = participants.findIndex(p => p.name === targetName); /* */
                    if (kickedUserIndex !== -1) {
                        const kickedUser = participants[kickedUserIndex]; /* */
                        // N√£o permite kickar o pr√≥prio admin ou outro admin/mod se n√£o for admin
                        if (kickedUser.isAdmin && !canAdmin) {
                            addPrivateMessage('Voc√™ n√£o pode expulsar outro administrador.', true);
                            return true;
                        }
                         if (kickedUser.isMod && !canAdmin && canMod && kickedUser.name !== myName) {
                            addPrivateMessage('Moderadores n√£o podem expulsar outros moderadores.', true);
                            return true;
                        }
                        if (kickedUser.name === myName) {
                             addPrivateMessage('Voc√™ n√£o pode expulsar a si mesmo.', true);
                             return true;
                        }

                        participants.splice(kickedUserIndex, 1);
                        updateParticipantList();
                        addSystemMessage(`${kickedUser.name} foi expulso da sala. Motivo: ${restOfMessage || 'Nenhum.'}`); /* */
                        // Em um app real, o usu√°rio 'kickedUser.name' seria for√ßado a sair. /* */
                        // Aqui, simulamos se ele fosse a inst√¢ncia atual.
                        if (myName === kickedUser.name) {
                            alert('Voc√™ foi expulso da sala!'); /* */
                            window.location.reload(); // Volta para o menu principal
                        }
                    } else {
                        addPrivateMessage(`Usu√°rio "${targetName}" n√£o encontrado.`, true); /* */
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/ban':
                if (canAdmin) {
                    if (!targetName || !restOfMessage) {
                        addPrivateMessage('Uso: /Ban (Nome do usuario) (Mensagem) (Tempo ex: 10m, 5h, 30s)', true); /* */
                        return true;
                    }
                    // Express√£o regular para separar o motivo do tempo
                    const match = restOfMessage.match(/(.*)\s+(\d+[hms])$/i);
                    let reason = 'Nenhum.';
                    let timeStr = '';

                    if (match) {
                        reason = match[1].trim();
                        timeStr = match[2];
                    } else {
                        // Se n√£o encontrou o padr√£o com tempo no final, tenta parsear o √∫ltimo elemento como tempo
                        const lastPart = parts[parts.length - 1];
                        if (lastPart.match(/\d+[hms]/i)) {
                            timeStr = lastPart;
                            reason = parts.slice(2, -1).join(' ').trim();
                        } else {
                            addPrivateMessage('Formato de comando /ban inv√°lido. Uso: /Ban (Nome) (Motivo) (Tempo ex: 10m, 5h, 30s)', true);
                            return true;
                        }
                    }

                    let banDurationMs = 0; /* */
                    const timeValue = parseInt(timeStr.match(/\d+/)[0]);
                    const timeUnit = timeStr.match(/[hms]/i)[0]; // h=horas, m=minutos, s=segundos

                    if (timeUnit.toLowerCase() === 'm') banDurationMs = timeValue * 60 * 1000; /* */
                    else if (timeUnit.toLowerCase() === 'h') banDurationMs = timeValue * 60 * 60 * 1000; /* */
                    else if (timeUnit.toLowerCase() === 's') banDurationMs = timeValue * 1000; /* */
                    else {
                        addPrivateMessage('Formato de tempo inv√°lido (ex: 10m, 5h, 30s).', true); /* */
                        return true;
                    }

                    const banUntil = Date.now() + banDurationMs; /* */
                    bannedUsers.set(targetName, { banUntil, reason: reason || 'Nenhum.' });

                    const bannedUserIndex = participants.findIndex(p => p.name === targetName); /* */
                    if (bannedUserIndex !== -1) {
                        participants.splice(bannedUserIndex, 1); /* */
                        // Remove da lista de participantes ativos
                        updateParticipantList(); /* */
                    }

                    addSystemMessage(`${targetName} foi banido da sala por ${timeValue}${timeUnit.toLowerCase()}. Motivo: ${reason || 'Nenhum.'}`); /* */
                    if (myName === targetName) {
                        alert('Voc√™ foi banido da sala!'); /* */
                        window.location.reload();
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/reload':
            case '/reloadall':
                if (canAdmin) {
                    addSystemMessage('O administrador iniciou um recarregamento da sala. A p√°gina ser√° atualizada para todos!'); /* */
                    setTimeout(() => window.location.reload(), 2000); // D√° um tempo para a mensagem aparecer
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/admin':
                if (canAdmin) {
                    if (!targetName) {
                        addPrivateMessage('Uso: /Admin (Nome do usuario)', true); /* */
                        return true;
                    }
                    const targetParticipant = participants.find(p => p.name === targetName); /* */
                    if (targetParticipant) {
                        targetParticipant.isAdmin = true; /* */
                        targetParticipant.isMod = false; // Remove mod se for admin
                        updateParticipantList(); /* */
                        addSystemMessage(`${targetName} agora √© um administrador!`);
                    } else {
                        addPrivateMessage(`Usu√°rio "${targetName}" n√£o encontrado na sala.`, true); /* */
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/revoke-admin':
                if (canAdmin) {
                    if (!targetName) {
                        addPrivateMessage('Uso: /Revoke-Admin (Nome do usuario)', true); /* */
                        return true;
                    }
                    const targetParticipant = participants.find(p => p.name === targetName); /* */
                    if (targetParticipant && targetParticipant.name !== myName) { // Admin n√£o pode remover seus pr√≥prios privil√©gios
                        targetParticipant.isAdmin = false; /* */
                        updateParticipantList();
                        addSystemMessage(`${targetName} n√£o √© mais um administrador.`);
                    } else if (targetParticipant && targetParticipant.name === myName) {
                        addPrivateMessage('Voc√™ n√£o pode remover seus pr√≥prios privil√©gios de administrador. Pe√ßa a outro administrador.', true); /* */
                    }
                    else {
                        addPrivateMessage(`Usu√°rio "${targetName}" n√£o encontrado na sala.`, true); /* */
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/mod':
                if (canAdmin) {
                    if (!targetName) {
                        addPrivateMessage('Uso: /Mod (Nome do usuario)', true); /* */
                        return true;
                    }
                    const targetParticipant = participants.find(p => p.name === targetName); /* */
                    if (targetParticipant) {
                        targetParticipant.isMod = true; /* */
                        updateParticipantList();
                        addSystemMessage(`${targetName} agora √© um moderador!`);
                    } else {
                        addPrivateMessage(`Usu√°rio "${targetName}" n√£o encontrado na sala.`, true); /* */
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            case '/revoke-mod':
                if (canAdmin) {
                    if (!targetName) {
                        addPrivateMessage('Uso: /Revoke-Mod (Nome do usuario)', true); /* */
                        return true;
                    }
                    const targetParticipant = participants.find(p => p.name === targetName); /* */
                    if (targetParticipant) {
                        targetParticipant.isMod = false; /* */
                        updateParticipantList();
                        addSystemMessage(`${targetName} n√£o √© mais um moderador.`);
                    } else {
                        addPrivateMessage(`Usu√°rio "${targetName}" n√£o encontrado na sala.`, true); /* */
                    }
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            // --- Comandos para Todos os Usu√°rios ---
            case '/help':
                let helpMessage = "Comandos dispon√≠veis:\n"; /* */
                helpMessage += "/Version - Exibe a vers√£o.\n";
                helpMessage += "/Admin - Mostra quem √© o admin da sala.\n"; /* */
                helpMessage += "/sendlink - Envia um link privado para o admin.\n";
                helpMessage += "/code - Mostra o c√≥digo da sala.\n"; /* */
                // Novo comando
                helpMessage += "/exit - Sai da sala.\n"; /* */
                if (canAdmin) {
                    helpMessage += "\nComandos de Admin:\n"; /* */
                    helpMessage += "/Clear All - Limpa o chat.\n";
                    helpMessage += "/Kick (Nome) (Motivo) - Expulsa um usu√°rio.\n"; /* */
                    helpMessage += "/Ban (Nome) (Motivo) (Tempo) - Bane um usu√°rio (ex: 10m, 2h).\n"; /* */
                    helpMessage += "/reload all - Recarrega a p√°gina para todos.\n";
                    helpMessage += "/Admin (Nome) - Concede admin a algu√©m.\n"; /* */
                    helpMessage += "/Revoke-Admin (Nome) - Remove admin de algu√©m.\n";
                    helpMessage += "/Mod (Nome) - Concede moderador a algu√©m.\n"; /* */
                    helpMessage += "/Revoke-Mod (Nome) - Remove moderador de algu√©m.\n";
                    helpMessage += "/exitall - Tira todos da sala.\n"; /* */
                } else if (canMod) {
                    helpMessage += "\nComandos de Moderador:\n"; /* */
                    helpMessage += "/Clear All - Limpa o chat.\n";
                    helpMessage += "/Kick (Nome) (Motivo) - Expulsa um usu√°rio.\n"; /* */
                    // Adicione outros comandos de mod aqui se houver
                }
                addPrivateMessage(helpMessage); /* */
                return true;

            case '/version':
                addPrivateMessage('Vers√£o Beta ;-)'); /* */
                return true;

            case '/admin': // Comando /Admin para n√£o-admins (mostra quem √© o admin)
                const currentAdmin = participants.find(p => p.isAdmin); /* */
                if (currentAdmin) {
                    addPrivateMessage(`O administrador da sala √©: ${currentAdmin.name}`); /* */
                } else {
                    addPrivateMessage('N√£o h√° um administrador definido no momento.', true); /* */
                }
                return true; /* */
            case '/sendlink':
                const linkToSend = prompt('Digite o link que deseja enviar ao administrador:'); /* */
                if (linkToSend) {
                    const currentAdmin = participants.find(p => p.isAdmin); /* */
                    if (currentAdmin) {
                         // Simula o admin recebendo a mensagem privada
                        if (myName === currentAdmin.name) {
                            addPrivateMessage(`LINK PRIVADO DO USU√ÅRIO ${myName}: ${linkToSend}`, true); /* */
                        } else {
                            addPrivateMessage(`O link foi enviado para o administrador (${currentAdmin.name}).`); /* */
                        }
                    } else {
                        addPrivateMessage('N√£o h√° um administrador online para receber o link.', true); /* */
                    }
                }
                return true; /* */
            case '/code': // Novo comando /code
                if (roomID) {
                    addPrivateMessage(`O c√≥digo da sala √©: ${roomID}`); /* */
                } else {
                    addPrivateMessage('Voc√™ n√£o est√° em uma sala ativa.', true); /* */
                }
                return true; /* */
            case '/exit':
                addPrivateMessage('Voc√™ saiu da sala.'); /* */
                setTimeout(() => window.location.reload(), 1000); // Redireciona para o menu principal
                return true; /* */
            case '/exitall':
                if (canAdmin) {
                    addSystemMessage('O administrador encerrou a sess√£o. Todos ser√£o redirecionados para o menu principal!'); /* */
                    // Em um app real, o servidor enviaria um comando para todos os clientes
                    setTimeout(() => window.location.reload(), 2000); /* */
                } else {
                    addPrivateMessage('Voc√™ n√£o tem permiss√£o para usar este comando.', true); /* */
                }
                return true; /* */
            default:
                // Se come√ßar com / mas n√£o for um comando reconhecido
                if (message.startsWith('/')) {
                    addPrivateMessage(`Comando desconhecido: ${command}. Digite /help para ver os comandos dispon√≠veis.`, true); /* */
                    return true;
                }
                return false; /* */
            // N√£o √© um comando, processe como mensagem normal
        }
    }

    // Sobrescrevendo a fun√ß√£o sendMessage para incluir o tratamento de comandos
    function sendMessage() {
      const input = document.getElementById('chatInput'); /* */
      let msg = input.value.trim();
      if (!msg) return;

      if (msg.length > 900) {
        alert('Mensagem excede 900 caracteres.'); /* */
        return;
      }

      // Limpa input
      input.value = ''; /* */
      // Tenta processar como comando primeiro
      if (handleCommand(msg)) {
          // Se for um comando e foi processado, n√£o adiciona como mensagem normal
          return; /* */
      }

      // Se n√£o for um comando, adiciona mensagem normal
      addChatMessage(myName, msg); /* */
      // Simula broadcast da mensagem para os outros participantes (apenas se n√£o for comando)
      broadcastChatMessage(myName, msg); /* */
    }

    // Fun√ß√£o para gerar e compartilhar o link da sala
    async function generateShareLink() {
        if (!roomID) {
            alert('Voc√™ precisa estar em uma sala para compartilhar o c√≥digo.'); /* */
            return;
        }

        // Substitua 'Player-HTML-CSS-JS.html' pelo nome real do seu arquivo HTML se for public√°-lo
        const currentFile = window.location.pathname.split('/').pop() || 'Player-HTML-CSS-JS.html'; /* */
        const shareLink = `${window.location.origin}/${currentFile}?CODE=${roomID}`;

        if (navigator.share) {
            // API de compartilhamento nativo para Android/Mobile
            try {
                await navigator.share({
                    title: 'Entrar na Sala!',
                    text: `Junte-se √† minha sala! C√≥digo: ${roomID}`, /* */
                    url: shareLink,
                }); /* */
                addPrivateMessage('Link de compartilhamento enviado com sucesso!', false);
            } catch (error) {
                if (error.name !== 'AbortError') { // Ignora se o usu√°rio cancelou
                    addPrivateMessage(`Erro ao compartilhar link: ${error.message}`, true); /* */
                }
            }
        } else {
            // Fallback para PC: Copiar para a √°rea de transfer√™ncia
            try {
                await navigator.clipboard.writeText(shareLink); /* */
                addPrivateMessage('C√≥digo da sala copiado para a √°rea de transfer√™ncia! Compartilhe o link: ' + shareLink); /* */
            } catch (err) {
                addPrivateMessage('Falha ao copiar o link. Por favor, copie manualmente: ' + shareLink, true); /* */
            }
        }
    }

    // Eventos para enviar mensagem
    document.getElementById('sendChatBtn').onclick = sendMessage; /* */
    document.getElementById('chatInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }); /* */
    // Evento para o novo bot√£o de compartilhar
    document.getElementById('shareRoomCodeBtn').onclick = generateShareLink; /* */
    // Garante que o rejectedNotice tenha display: flex
    document.getElementById('rejectedNotice').style.display = 'none'; // Define como none inicialmente

    // Chama a fun√ß√£o para processar o link de convite quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', processInviteLink); /* */
  </script>
</body>
</html>
